name: Build Rubberband CLI ARMv7

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        repository: breakfastquay/rubberband
        ref: v4.0.0
        submodules: recursive
    
    - uses: nttld/setup-ndk@v1
      with:
        ndk-version: r26d
        add-to-path: true
    
    - run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build pkg-config
    
    - run: |
        cat > android-armv7.txt << 'EOF'
        [binaries]
        c = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang'
        cpp = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang++'
        ar = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar'
        strip = '$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip'
        
        [host_machine]
        system = 'android'
        cpu_family = 'arm'
        cpu = 'armv7a'
        endian = 'little'
        
        [properties]
        needs_exe_wrapper = true
        EOF
        envsubst < android-armv7.txt > android-armv7-resolved.txt
    
    - run: |
        meson setup builddir \
          --cross-file=android-armv7-resolved.txt \
          --buildtype=release \
          -Dfft=kissfft \
          -Dresampler=builtin \
          -Dcmdline=enabled
    
    - run: meson compile -C builddir
    
    - uses: actions/upload-artifact@v4
      with:
        name: rubberband-cli-armeabi-v7a
        path: builddir/rubberband
